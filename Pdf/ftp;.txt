import java.io.*;
import java.net.*;
import java.util.Scanner;

public class FTPCliente {

    private static final String HOST = "localhost";
    private static final int PUERTO = 2121;

    public static void main(String[] args) {
        try (Socket socket = new Socket(HOST, PUERTO);
             BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
             PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
             Scanner sc = new Scanner(System.in)) {

            System.out.println(in.readLine()); // Mensaje de bienvenida

            String comando;
            while (true) {
                System.out.print("ftp> ");
                comando = sc.nextLine();
                out.println(comando);

                if (comando.equalsIgnoreCase("QUIT")) break;

                if (comando.startsWith("DOWNLOAD")) {
                    recibirArchivo(in, comando.split(" ")[1]);
                } else if (comando.startsWith("UPLOAD")) {
                    enviarArchivo(comando.split(" ")[1], out);
                } else { // LIST o mensajes de texto
                    String respuesta;
                    while (!(respuesta = in.readLine()).equals("FIN_LISTA") && !respuesta.startsWith("ARCHIVO") && !respuesta.startsWith("ERROR")) {
                        System.out.println(respuesta);
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static void recibirArchivo(BufferedReader in, String nombreArchivo) throws IOException {
        File archivo = new File(nombreArchivo);
        try (BufferedWriter bw = new BufferedWriter(new FileWriter(archivo))) {
            String linea;
            while (!(linea = in.readLine()).equals("FIN_ARCHIVO")) {
                bw.write(linea);
                bw.newLine();
            }
            bw.flush();
            System.out.println("Archivo recibido: " + nombreArchivo);
        }
    }

    private static void enviarArchivo(String nombreArchivo, PrintWriter out) throws IOException {
        File archivo = new File(nombreArchivo);
        if (!archivo.exists()) {
            System.out.println("Archivo no encontrado: " + nombreArchivo);
            return;
        }

        // Espera a que el servidor diga que est√° listo
        Scanner sc = new Scanner(System.in); // no estrictamente necesario
        BufferedReader dummy = new BufferedReader(new InputStreamReader(System.in));
        Thread.sleep(100); // breve pausa

        try (BufferedReader br = new BufferedReader(new FileReader(archivo))) {
            String linea;
            while ((linea = br.readLine()) != null) {
                out.println(linea);
            }
        }
        out.println(); // final
        System.out.println("Archivo enviado: " + nombreArchivo);
    }
}
import java.io.*;
import java.net.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class FTPServidor {

    private static final int PUERTO = 2121;
    private static final String DIRECTORIO_RAIZ = "ftp_root";
    private static final int MAX_CLIENTES = 10;

    public static void main(String[] args) {
        File root = new File(DIRECTORIO_RAIZ);
        if (!root.exists()) {
            root.mkdir();
        }

        ExecutorService pool = Executors.newFixedThreadPool(MAX_CLIENTES);

        try (ServerSocket serverSocket = new ServerSocket(PUERTO)) {
            System.out.println("Servidor FTP iniciado en puerto " + PUERTO);

            while (true) {
                Socket cliente = serverSocket.accept();
                System.out.println("Cliente conectado: " + cliente.getInetAddress());
                pool.execute(new ManejadorCliente(cliente, root));
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

class ManejadorCliente implements Runnable {

    private Socket socket;
    private File directorioActual;

    public ManejadorCliente(Socket socket, File root) {
        this.socket = socket;
        this.directorioActual = root;
    }

    @Override
    public void run() {
        try (
            BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
        ) {
            out.println("Bienvenido al servidor FTP simple!");

            String comando;
            while ((comando = in.readLine()) != null) {
                if (comando.startsWith("LIST")) {
                    listarArchivos(out);
                } else if (comando.startsWith("UPLOAD")) {
                    recibirArchivo(comando, in, out);
                } else if (comando.startsWith("DOWNLOAD")) {
                    enviarArchivo(comando, out);
                } else if (comando.equalsIgnoreCase("QUIT")) {
                    out.println("Adios!");
                    break;
                } else {
                    out.println("Comando no reconocido.");
                }
            }
        } catch (IOException e) {
            System.out.println("Cliente desconectado: " + socket.getInetAddress());
        }
    }

    private void listarArchivos(PrintWriter out) {
        File[] archivos = directorioActual.listFiles();
        if (archivos != null) {
            for (File f : archivos) {
                out.println(f.getName() + (f.isDirectory() ? "/" : ""));
            }
        }
        out.println("FIN_LISTA");
    }

    private void recibirArchivo(String comando, BufferedReader in, PrintWriter out) throws IOException {
        String[] partes = comando.split(" ");
        if (partes.length != 2) {
            out.println("USO: UPLOAD nombreArchivo");
            return;
        }
        String nombreArchivo = partes[1];
        out.println("LISTO_PARA_RECIBIR");

        try (BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(new File(directorioActual, nombreArchivo)))) {
            char[] buffer = new char[4096];
            int leidos;
            while ((leidos = in.read(buffer)) != -1) {
                bos.write(new String(buffer, 0, leidos).getBytes());
                if (leidos < buffer.length) break;
            }
            bos.flush();
            out.println("ARCHIVO_RECIBIDO");
        }
    }

    private void enviarArchivo(String comando, PrintWriter out) {
        String[] partes = comando.split(" ");
        if (partes.length != 2) {
            out.println("USO: DOWNLOAD nombreArchivo");
            return;
        }

        File archivo = new File(directorioActual, partes[1]);
        if (!archivo.exists()) {
            out.println("ERROR: Archivo no encontrado");
            return;
        }

        try (BufferedReader br = new BufferedReader(new FileReader(archivo))) {
            String linea;
            while ((linea = br.readLine()) != null) {
                out.println(linea);
            }
            out.println("FIN_ARCHIVO");
        } catch (IOException e) {
            out.println("ERROR: No se pudo enviar el archivo");
        }
    }
}
